---
title: "black rail sdm"
author: "Mike Allen"
date: "8/28/2020"
output: html_document
---
# Load libraries, spatial & occupancy data
```{r}
library(tidyverse)
library(lubridate)
library(sf)
library(raster)
library(fasterize)
library(dbplyr)
library(RSQLite)
# devtools::install_git("https://github.com/cran/zipcode")
# library(zipcode) # I don't think this package got used
`%notin%` <- Negate(`%in%`)
# set map projection to Albers Equal Area to match GAP data 
map_proj = "+proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs" # aka 42303
mol <- "+proj=moll +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84"

# Load and format spatial & occupancy data

# Load spatial covariate data
# Note: processing steps are also detailed in the comments of the sourced script file
source("scripts/load_spatial_covariate_data.R")

# Load spatial ownership data (just npp_parcels_owners_marsh unless you uncomment others)
# Note: processing steps are also detailed in the comments of the sourced script file
source("scripts/load_spatial_ownership_data.R")

# Get spatial covariates from cells within emergent tidal marsh by ownership type
# note: create this file using the function "get_covs_by_owner()"
# note: be sure the script "load_latest_owner_polys.R" is up to date first
# note: takes over an hour
# source("scripts/get_covs_by_owner_function.R")
# get_covs_by_owner(out_file = "D:/black_rail/big_output_2021_10/csv/owner_covs_data_20210325.csv")
owner_covs_data <- read.csv(
  "D:/black_rail/big_output_2021_10/csv/owner_covs_data_20210325.csv"
  )

# Read in and format ENSP Black Rail survey data, eBird data
# And format everything for occupancy analysis
source("scripts/read_and_format_occupancy_data.R")
```
# Bayesian occupancy model - ENSP data only
Code modified from Kery & Royle AHM1 book (Ch 10); covariates based on Stevens & Conway (ACJV model). Hours relative to midnight 95% CI overlapped zero. Ordinal date doesn't. Psi results change little with different detection models.
```{r}
# Inits
inits <- function(){list(z = apply(b.occ.mat, 1, max, na.rm = T), mean.psi = runif(1), mean.p = runif(1), alpha = -1+rnorm(1), beta = (c(3,-3,-5,-3,3,5,-5, 2)+rnorm(8)))}

params <- c("alpha0", "alpha", "beta0", "beta", "state.sum", "fed.sum", "npp.sum", "nonp.sum", "mun.sum", "county.sum", 
            "psi.hm", "psi.ss", "psi.tb", "psi.ldev", "psi.ss", "p.ord", "fed.pct", "nonp.pct", "state.pct", "county.pct", "mun.pct", "npp.pct", "all.sum")

params_loo <- c("alpha0", "alpha", "beta0", "beta", "log.lik.cum") 

# MCMC settings
ni <- 50000   ;   nt <- 10   ;   nb <- 10000   ;   nc <- 3
ni_loo <- 230000   ;   nb_loo <- 30000

# run model
ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im <-
  jagsUI::jags(
    ensp.jags.data,
    inits,
    params,
    "scripts/ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im_predictions.txt",
    n.chains = nc,
    n.thin = nt,
    n.iter = ni,
    n.burnin = nb,
    parallel = TRUE
  )

# jagsUI::traceplot(ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im)
# ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im
save(ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im,
     file = "D:/BLRA_files/big_files/JAGS_ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im_12000iter_pred_full2.Rdata")
```
# Bayesian occupancy model - ENSP & eBird data combined
```{r}
# Inits
inits <- function(){list(z = apply(b.occ.mat.ensp_ebird, 1, max, na.rm = T), mean.psi = runif(1), mean.p = runif(1), alpha = c(-1, 1) + rnorm(2), beta = (c(rep(0, 10), -2,-1,2, 0,-2,-2)+rnorm(16)))}

# Parameters monitored
params <- c("alpha0", "alpha", "beta0", "beta", "psi.hm", "psi.ss", "psi.ldev", "psi.tb", "p.ord", "p.dur", "state.sum", "fed.sum", "npp.sum", "nonp.sum", "mun.sum", "county.sum", "fed.pct", "nonp.pct", "state.pct", "county.pct", "mun.pct", "npp.pct", "all.sum") # "log.lik.cum",

# MCMC settings
# ni <- 230000   ;   nt <- 10   ;   nb <- 30000   ;   nc <- 3 # for LOO calculations & params
ni <- 50000   ;   nt <- 10   ;   nb <- 10000   ;   nc <- 3 # for prediction

# Call JAGS from R and summarize posteriors
ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im <-
  jagsUI::jags(
    ensp_ebird.jags.data,
    inits,
    params,
    "scripts/ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_predictions.txt",
    n.chains = nc,
    n.thin = nt,
    n.iter = ni,
    n.burnin = nb,
    parallel = TRUE
  )
# jagsUI::traceplot(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im)
# ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im

 save(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im, file = "D:/BLRA_files/big_files/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full2.Rdata")

# library(loo)
# (WAIC.0 <- waic(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$log.lik.cum))
# (loo.ensp_ebird.dur <- loo(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$log.lik.cum))
# save(loo.ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im, file = "D:/BLRA_files/big_files/loo.ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im.Rdata")
# load("D:/BLRA_files/big_files/loo.ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im.Rdata")
# load("D:/BLRA_files/big_files/loo.ensp_ebird_p.ord_psi.yr.ss.hm.tb.ld.im.Rdata")
# loo::loo_compare(loo.ensp_ebird_p.ord_psi.yr.ss.hm.tb.ld.im, loo.ensp_ebird.dur)


```
# Figure - psi from ensp & ebird combined
```{r}
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full.Rdata")

ensp.ebird_hm_psi <- apply(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$psi.hm, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

ensp.ebird_hm_psi.plot <-
  data.frame(
    ensp.ebird_hm_psi,
    hm = seq(0, 0.7653146, length.out = 50)
  )

colnames(ensp.ebird_hm_psi.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "hm")

(psi.hm <- ggplot(ensp.ebird_hm_psi.plot) +
  geom_ribbon(aes(x = hm*100, ymin = p2.75*100, ymax = p97.5*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = hm*100, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = hm*100, y = p50*100), color = "firebrick", size = 2) +
  labs(x = "High marsh (% area within 500 m)", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
)

ggsave("figures/Fig_psi_vs_hm_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im.png", width = 7, height = 5)
```
# Figure - psi from ensp & ebird combined (low-intensity development)
```{r}
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full.Rdata")

ensp.ebird_ldev_psi <- apply(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$psi.ldev, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

ensp.ebird_ldev_psi.plot <-
  data.frame(
    ensp.ebird_ldev_psi,
    ldev = seq(0, 0.755102, length.out = 50)
  )

colnames(ensp.ebird_ldev_psi.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "ldev")

(psi.ldev <- ggplot(ensp.ebird_ldev_psi.plot) +
  geom_ribbon(aes(x = ldev*100, ymin = p2.75*100, ymax = p97.5*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = ldev*100, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = ldev*100, y = p50*100), color = "firebrick", size = 2) +
  labs(x = "Low-intensity development (% area within 100 m)", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
)

# ggsave("figures/Fig_psi_vs_ldev_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im.png", width = 7, height = 5)
```

# Figure - psi from ensp & ebird combined (scrub-shrub)
```{r}
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full.Rdata")

ensp.ebird_ss_psi <- apply(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$psi.ss, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

ensp.ebird_ss_psi.plot <-
  data.frame(
    ensp.ebird_ss_psi,
    ss = seq(0, 0.6134549, length.out = 50)
  )

colnames(ensp.ebird_ss_psi.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "ss")

(psi.ss <- ggplot(ensp.ebird_ss_psi.plot) +
  geom_ribbon(aes(x = ss*100, ymin = p2.75*100, ymax = p97.5*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = ss*100, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = ss*100, y = p50*100), color = "firebrick", size = 2) +
  labs(x = "Scrub-shrub wetland (% area within 500 m)", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
)

# ggsave("figures/Fig_psi_vs_ss_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im.png", width = 7, height = 5)
```
# Figure - psi from ensp & ebird combined (terrestrial border)
```{r}
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full.Rdata")

ensp.ebird_tb_psi <- apply(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$psi.tb, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

ensp.ebird_tb_psi.plot <-
  data.frame(
    ensp.ebird_tb_psi,
    tb = seq(0, 0.5520833, length.out = 50)
  )

colnames(ensp.ebird_tb_psi.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "tb")

(psi.tb <- ggplot(ensp.ebird_tb_psi.plot) +
  geom_ribbon(aes(x = tb*100, ymin = p2.75*100, ymax = p97.5*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_ribbon(aes(x = tb*100, ymin = p10*100, ymax = p90*100),
              fill = "firebrick",
              alpha = 0.3) +
  geom_line(aes(x = tb*100, y = p50*100), color = "firebrick", size = 2) +
  labs(x = "Terrestrial-wetland border (% area within 500 m)", y = "Occupancy probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
)

# ggsave("figures/Fig_psi_vs_tb_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im.png", width = 7, height = 5)
```

# Figure - p from ensp & ebird combined (duration)
```{r}
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full.Rdata")

ensp.ebird_dur_p <- apply(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$p.dur, 2, function(x) quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

ensp.ebird_dur_p.plot <-
  data.frame(
    ensp.ebird_dur_p,
    dur = seq(0.001, 5, length.out = 50)
  )

colnames(ensp.ebird_dur_p.plot) <- c("p2.75", "p10", "p50", "p90", "p97.5", "dur")

(p.dur <- ggplot(ensp.ebird_dur_p.plot) +
  geom_ribbon(aes(x = dur, ymin = p2.75*100, ymax = p97.5*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_ribbon(aes(x = dur, ymin = p10*100, ymax = p90*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_line(aes(x = dur, y = p50*100), color = "steelblue", size = 2) +
  labs(x = "Duration of count (hours)", y = "Detection probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
)

# ggsave("figures/Fig_p_dur_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im2.png", width = 7, height = 5)
```
# Figure - p from ensp & ebird combined (ordinal date)
```{r}
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full.Rdata")

ensp.ebird_ord_p <-
  apply(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$p.ord, 2, function(x)
    quantile(x, c(0.0275, 0.1, 0.5, 0.9, 0.975))) %>%
  t() %>%
  as.data.frame()

ensp.ebird_ord_p.plot <-
  data.frame(
    ensp.ebird_ord_p,
    dur = seq(1.19, 1.96, length.out = 50)
  )
colnames(ensp.ebird_ord_p.plot) <- 
  c("p2.75", "p10", "p50", "p90", "p97.5", "ord")

(p.ord <- ggplot(ensp.ebird_ord_p.plot) +
  geom_ribbon(aes(x = ord*100, ymin = p2.75*100, ymax = p97.5*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_ribbon(aes(x = ord*100, ymin = p10*100, ymax = p90*100),
              fill = "steelblue",
              alpha = 0.3) +
  geom_line(aes(x = ord*100, y = p50*100), color = "steelblue", size = 2) +
  labs(x = "Ordinal date", y = "Detection probability (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
)

# ggsave("figures/Fig_p_ord_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im2.png", width = 7, height = 5)
```
# Create Fig. S4 - Composite of prediction plots
```{r}
require(gridExtra)
grid.arrange(psi.hm, psi.ss, psi.ldev, psi.tb, p.ord, p.dur)

# ggsave("figures/FigS4_prediction_plots2.pdf", arrangeGrob(psi.hm, psi.ss, psi.ldev, psi.tb, p.ord, p.dur), width= 10, height = 13, dpi = 600)
```
# Create Fig. S1 - Comparing covariate space of data sources vs. all marsh (entire raster)
```{r}
cov.plot.data = b.brick_pred_pts %>%
  as.data.frame() %>%
  mutate(survey = 2) %>%
  dplyr::select(-x, -y) %>%
  rename(ss.500 = ss.500_pred,
         sharp_hm.500 = sharp_hm.500_pred,
         sharp_tb.500 = sharp_tb.500_pred,
         ldev.100 = ldev.100_pred,
         imp.500 = imp.500_pred) %>%
  bind_rows(dplyr::select(b.site.cov.ensp_ebird, -yearfac)) %>%
  mutate(type = case_when(survey == 1 ~ "survey points",
                          survey == 0 ~ "eBird points",
                          survey == 2 ~ "all marshes")) %>%
  dplyr::select(-survey) %>%
  pivot_longer(cols = ss.500:imp.500)

ggplot(cov.plot.data, aes(x = sqrt(value), y = type)) +
  geom_boxplot(fill = "steelblue", size = .1) + 
  facet_wrap(~name) +
  cowplot::theme_cowplot() +
  labs(y = "", x = "Area (square root proportion within 500 m)")
# ggsave("figures/FigS1_covariate_space_ensp_ebird.png", width = 7, height = 5)

```
# Create Fig. S3 - Plot marsh area with area occupied by rails
```{r}
# Total occupied units by ownership - ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im
# Load JAGS output for ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full2.Rdata")

# Summarize posteriors for the total area occupied estimates
area_occ_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im <- data.frame(
  state.sum = ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$state.sum,
  fed.sum = ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$fed.sum,
  npp.sum = ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$npp.sum,
  nonp.sum = ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$nonp.sum,
  mun.sum = ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$mun.sum,
  county.sum = ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$county.sum
) %>%
  aggregate(by = list(rep(1, 12000)), function(x) quantile(x, c(.025, .1, .5, .9, .975))) %>%
  dplyr::select(-Group.1) %>% 
  t() %>%
  as.data.frame() %>%
  mutate(pct=rep(c("q2.5", "q10", "med", "q90", "q97.5"), 6),
         owner = c(rep("state", 5), rep("fed", 5), rep("npp", 5),
                   rep("nonp", 5), rep("mun", 5), rep("county", 5))) %>%
  pivot_wider(id_cols = owner, names_from = pct, values_from = V1) %>%
  mutate(order = 6:1,
         model = "Survey & eBird")

# Total occupied units by ownership - ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im
# Load JAGS output for ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im_12000iter_pred_full2.Rdata")

# Summarize posteriors for the total area occupied estimates
area_occ_ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im <- data.frame(
  state.sum = ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im$sims.list$state.sum,
  fed.sum = ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im$sims.list$fed.sum,
  npp.sum = ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im$sims.list$npp.sum,
  nonp.sum = ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im$sims.list$nonp.sum,
  mun.sum = ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im$sims.list$mun.sum,
  county.sum = ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im$sims.list$county.sum
) %>%
  aggregate(by = list(rep(1, 12000)), function(x) quantile(x, c(.025, .1, .5, .9, .975))) %>%
  dplyr::select(-Group.1) %>% 
  t() %>%
  as.data.frame() %>%
  mutate(pct=rep(c("q2.5", "q10", "med", "q90", "q97.5"), 6),
         owner = c(rep("state", 5), rep("fed", 5), rep("npp", 5),
                   rep("nonp", 5), rep("mun", 5), rep("county", 5))) %>%
  pivot_wider(id_cols = owner, names_from = pct, values_from = V1) %>%
  mutate(order = 6:1,
         model = "Survey only")

# combine summary data from both models
area_occ <- area_occ_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im %>%
  bind_rows(area_occ_ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im) %>%
  mutate(marsh.area = rep(c(ensp.jags.data$n.state,
                        ensp.jags.data$n.fed,
                        ensp.jags.data$n.npp,
                        ensp.jags.data$n.nonp,
                        ensp.jags.data$n.mun,
                        ensp.jags.data$n.county), 2),
         q2.5_pct = 100*q2.5 / marsh.area,
         q10_pct = 100*q10 / marsh.area,
         med_pct = 100*med / marsh.area,
         q90_pct = 100*q90 / marsh.area,
         q97.5_pct = 100*q97.5 / marsh.area)
         
area_occ$owner2 = factor(
  area_occ$owner,
  levels = c("county", "mun", "nonp", "fed", "npp", "state"),
  labels = c(
    "County",
    "Municipal",
    "Nonprofit",
    "Federal",
    "Private",
    "State"
  )
)

# Graph area occupied by ownership type
area_occ %>%
ggplot() +
  geom_point(
    aes(y = owner2, x = med*.09, color = model),
    position = position_dodge(width = .4),
    size = 4
  ) +
    geom_errorbar(
      aes(y = owner2, xmin = q10*.09, xmax = q90*.09, color = model),
      position = position_dodge(width = .4),
      width = 0,
      size = 1.25
    ) +
    geom_errorbar(
      aes(y = owner2, xmin = q2.5*.09, xmax = q97.5*.09, color = model),
      position = position_dodge(width = .4),
      width = 0,
      size = .5
    ) +
  scale_color_manual(values = c("olivedrab", "orange")) +
  labs(y = "", x = "Occupied marsh (ha)") +
    theme_bw() +
  theme(axis.title = element_text(size = 15),
        axis.text = element_text(size = 15))
# ggsave("figures/FigS3_AreaOfOccurrence_by_ownership.pdf", width = 7, height = 5, dpi = 600)

# relative
(area_of_occurrence_data_ensp.ebird_rel =
    area_occ_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im %>%
  mutate(med_rel = med / sum(med),
         q2.5_rel = q2.5 / sum(med),
         q97.5_rel = q97.5 / sum(med)))

# totals
cbind.data.frame(owner = area_occ$owner, 
                 occ = area_occ$med * 0.09, 
                 occ_LL = area_occ$q2.5 * 0.09,
                 occ_UL = area_occ$q97.5 * 0.09,
                 total = area_occ$marsh.area * 0.09, 
                 rel = area_occ$med / area_occ$marsh.area)
```
# Create Fig. S2 - Beta coefficients
```{r}
beta_posteriors_step1 <- data.frame(
rbind(ensp_p.ord_psi.y16.y18.y19.ss.hm.tb.ld.im$sims.list$beta[,4:8],
      ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im$sims.list$beta[,12:16])
) %>%
  aggregate(by = list(c(rep("A", 12000), rep("B", 12000))), function(x) quantile(x, c(.025, .1, .5, .9, .975))) %>%
  dplyr::select(-Group.1) %>% 
  t() %>%
  as.data.frame() %>%
  mutate(pct=rep(c("q2.5", "q10", "med", "q90", "q97.5"), 5),
         variable = c(rep("Shrub-scrub", 5), rep("High marsh", 5), 
                      rep("Terrestrial border", 5), rep("Low-int. developed", 5), 
                      rep("Impoundments", 5))) %>%
  pivot_wider(id_cols = variable, names_from = pct, values_from = V1:V2)

beta_posteriors <-
  beta_posteriors_step1 %>%
  rename(q2.5 = V1_q2.5, q10 = V1_q10, med = V1_med, q90 = V1_q90, q97.5 = V1_q97.5) %>%
  dplyr::select(1:6) %>%
  rbind(dplyr::select(beta_posteriors_step1, c(1, q2.5 = V2_q2.5, q10 = V2_q10, med = V2_med, q90 = V2_q90, q97.5 = V2_q97.5))) %>%
  mutate(model = c(rep("Survey only", 5), rep("Survey & eBird", 5)))

rm(beta_posteriors_step1)

# Graph area occupied by ownership type
beta_posteriors %>%
ggplot() +
  geom_point(
    aes(y = variable, x = med, color = model),
    position = position_dodge(width = .4),
    size = 4
  ) +
    geom_errorbar(
      aes(y = variable, xmin = q10, xmax = q90, color = model),
      position = position_dodge(width = .4),
      width = 0,
      size = 1.25
    ) +
    geom_errorbar(
      aes(y = variable, xmin = q2.5, xmax = q97.5, color = model),
      position = position_dodge(width = .4),
      width = 0,
      size = .5
    ) +
  scale_color_manual(values = c("olivedrab", "orange")) +
  labs(y = "", x = "Beta coefficient") +
    theme_bw() +
  theme(axis.title = element_text(size = 15),
        axis.text = element_text(size = 15))

# ggsave("figures/FigS2_Beta_coefficients.pdf", width = 7, height = 5, dpi = 600)
```
# Creating prediction surface rasters from Bayesian models (created on Amarel HPC)
Median value and uncertainty per cell
```{r}
# Raster to mask tidal marsh prediction area
# includes only 30x30 cells contained within NJ emergent tidal marsh
# pred_mask <-
#   raster("D:/black_rail/big_output_2021_10/tif/pred_mask.tif")

ensp_cell_pred_med <-
  read.csv("D:/black_rail/big_output_2021_10/csv/ensp_cell_predict_out_summary.csv") %>%
  bind_cols(b.brick_pred_pts) %>%
  dplyr::select(x, y, med) %>% 
  rasterFromXYZ(crs = map_proj) %>%
  resample(pred_mask) %>%
  raster::mask(pred_mask)
 # writeRaster(ensp_cell_pred_med, "D:/black_rail/big_output_2021_10/tif/ensp_cell_pred_med.tif", overwrite = T)

ensp_cell_pred_2.5 <-
  read.csv("D:/black_rail/big_output_2021_10/csv/ensp_cell_predict_out_summary.csv") %>%
  bind_cols(b.brick_pred_pts) %>%
  dplyr::select(x, y, p2.5) %>% 
  rasterFromXYZ(crs = map_proj) %>%
  resample(pred_mask) %>%
  mask(pred_mask)
  # writeRaster(ensp_cell_pred_2.5, "D:/black_rail/big_output_2021_10/tif/ensp_cell_pred_2.5.tif", overwrite = T)

ensp_cell_pred_97.5 <-
  read.csv("D:/black_rail/big_output_2021_10/csv/ensp_cell_predict_out_summary.csv") %>%
  bind_cols(b.brick_pred_pts) %>%
  dplyr::select(x, y, p97.5) %>% 
  rasterFromXYZ(crs = map_proj) %>%
  resample(pred_mask) %>%
  mask(pred_mask)

ensp_cell_pred_CIwidth <- ensp_cell_pred_97.5 - ensp_cell_pred_2.5
 # writeRaster(ensp_cell_pred_CIwidth, "D:/black_rail/big_output_2021_10/tif/ensp_cell_pred_CIwidth.tif", overwrite = T)

# combined model

# ensp_ebird_cell_pred_dur_med <-
#   read.csv("D:/black_rail/big_output_2021_10/csv/ensp_ebird_cell_predict_out_summary_dur.csv") %>%
#   bind_cols(b.brick_pred_pts) %>%
#   dplyr::select(x, y, med) %>% 
#   rasterFromXYZ(crs = map_proj) %>%
#   resample(pred_mask) %>%
#   mask(pred_mask)
# writeRaster(ensp_ebird_cell_pred_dur_med, "D:/black_rail/big_output_2021_10/tif/ensp_ebird_cell_pred_dur_med.tif", overwrite = T)
ensp_ebird_cell_pred_dur_med <-
  raster("D:/black_rail/big_output_2021_10/tif/ensp_ebird_cell_pred_dur_med.tif")
# sum of med cells: 81620.84

# ensp_ebird_cell_pred_dur_2.5 <-
#   read.csv("D:/black_rail/big_output_2021_10/csv/ensp_ebird_cell_predict_out_summary_dur.csv") %>%
#   bind_cols(b.brick_pred_pts) %>%
#   dplyr::select(x, y, p2.5) %>% 
#   rasterFromXYZ(crs = map_proj) %>%
#   resample(pred_mask) %>%
#   mask(pred_mask)

# ensp_ebird_cell_pred_dur_97.5 <-
#   read.csv("D:/black_rail/big_output_2021_10//ensp_ebird_cell_predict_out_summary_dur.csv") %>%
#   bind_cols(b.brick_pred_pts) %>%
#   dplyr::select(x, y, p97.5) %>% 
#   rasterFromXYZ(crs = map_proj) %>%
#   resample(pred_mask) %>%
#   mask(pred_mask)

# ensp_ebird_cell_pred_dur_CIwidth <- 
#             ensp_ebird_cell_pred_dur_97.5 - ensp_ebird_cell_pred_dur_2.5
# writeRaster(ensp_ebird_cell_pred_dur_CIwidth, "D:/black_rail/big_output_2021_10/tif/ensp_ebird_cell_pred_dur_CIwidth.tif", overwrite = T)
```
# Create Fig.2 - ownership by habitat quality class
Note: can skip all these processing steps by running:
q <- readRDS("output/q.rds")
near the end of the chunk.
```{r}
# make function to calculate percentile
ecdf_fun <- function(x, perc) ecdf(x)(perc)

# load ensp & eBird model raster
# ensp_ebird_cell_pred_dur_med <-
#   raster("D:/black_rail/big_output_2021_10/tif/ensp_ebird_cell_pred_dur_med.tif")

# ensp & eBird model quantile raster
# temp <- ensp_ebird_cell_pred_dur_med
# temp[is.na(temp)] <- 2
# ensp.ebird_q_df <-
#   rasterToPoints(temp) %>%
#   as.data.frame() %>%
#   rename(p = 3) %>%
#   mutate(p2 = case_when(p==2 ~ NaN,
#                        TRUE ~ p),
#          pq = ecdf_fun(p2, p2))
# ensp.ebird_q <- ensp_ebird_cell_pred_dur_med %>%
#   setValues(ensp.ebird_q_df[,5])
# rm(ensp.ebird_q_df)
# rm(temp)

# first quartile
# ensp.ebird_q1 <- ensp.ebird_q
# ensp.ebird_q1[ensp.ebird_q1 > 0.25] <- NA
# saveRDS(ensp.ebird_q1, "D:/black_rail/big_output_2021_11/rds/ensp.ebird_q1.rds")
ensp.ebird_q1 <- readRDS("D:/black_rail/big_output_2021_11/rds/ensp.ebird_q1.rds")

# second quartile
# ensp.ebird_q2 <- ensp.ebird_q
# ensp.ebird_q2[ensp.ebird_q2 <= 0.25 | ensp.ebird_q2 > 0.50] <- NA
# saveRDS(ensp.ebird_q2, "D:/black_rail/big_output_2021_11/rds/ensp.ebird_q2.rds")
ensp.ebird_q2 <- readRDS("D:/black_rail/big_output_2021_11/rds/ensp.ebird_q2.rds")

# third quartile
# ensp.ebird_q3 <- ensp.ebird_q
# ensp.ebird_q3[ensp.ebird_q3 <= 0.5 | ensp.ebird_q3 > 0.75] <- NA
# saveRDS(ensp.ebird_q3, "D:/black_rail/big_output_2021_11/rds/ensp.ebird_q3.rds")
ensp.ebird_q3 <- readRDS("D:/black_rail/big_output_2021_11/rds/ensp.ebird_q3.rds")

# fourth quartile
# ensp.ebird_q4 <- ensp.ebird_q
# ensp.ebird_q4[ensp.ebird_q4 <= 0.75] <- NA
# saveRDS(ensp.ebird_q4, "D:/black_rail/big_output_2021_11/rds/ensp.ebird_q4.rds")
ensp.ebird_q4 <- readRDS("D:/black_rail/big_output_2021_11/rds/ensp.ebird_q4.rds")

# load ownership shapefiles
source("scripts/load_latest_owner_polys.R")

# extract function
count_cells <- function(raster, shapefile){
count_vector <- exactextractr::exact_extract(raster, shapefile)[[1]] %>%
  filter(is.na(value)==F)
count_sum <- sum(count_vector$coverage_fraction)
return(count_sum)
}

# make vector of all coverage values
q1 = c(
  fed_q1 = count_cells(ensp.ebird_q1, fed_PA_marsh),
  state_q1 = count_cells(ensp.ebird_q1, state_PA_marsh),
  county_q1 = count_cells(ensp.ebird_q1, county_PA_marsh),
  mun_q1 = count_cells(ensp.ebird_q1, mun_PA_marsh),
  nonp_q1 = count_cells(ensp.ebird_q1, nonp_PA_marsh),
  npp_q1 = count_cells(ensp.ebird_q1, npp_owners_marsh_dis)
)

q2 = c(
  fed_q2 = count_cells(ensp.ebird_q2, fed_PA_marsh),
  state_q2 = count_cells(ensp.ebird_q2, state_PA_marsh),
  county_q2 = count_cells(ensp.ebird_q2, county_PA_marsh),
  mun_q2 = count_cells(ensp.ebird_q2, mun_PA_marsh),
  nonp_q2 = count_cells(ensp.ebird_q2, nonp_PA_marsh),
  npp_q2 = count_cells(ensp.ebird_q2, npp_owners_marsh_dis)
)

q3 = c(
fed_q3 = count_cells(ensp.ebird_q3, fed_PA_marsh),
state_q3 = count_cells(ensp.ebird_q3, state_PA_marsh),
county_q3 = count_cells(ensp.ebird_q3, county_PA_marsh),
mun_q3 = count_cells(ensp.ebird_q3, mun_PA_marsh),
nonp_q3 = count_cells(ensp.ebird_q3, nonp_PA_marsh),
npp_q3 = count_cells(ensp.ebird_q3, npp_owners_marsh_dis)
)

q4 = c(
fed_q4 = count_cells(ensp.ebird_q4, fed_PA_marsh),
state_q4 = count_cells(ensp.ebird_q4, state_PA_marsh),
county_q4 = count_cells(ensp.ebird_q4, county_PA_marsh),
mun_q4 = count_cells(ensp.ebird_q4, mun_PA_marsh),
nonp_q4 = count_cells(ensp.ebird_q4, nonp_PA_marsh),
npp_q4 = count_cells(ensp.ebird_q4, npp_owners_marsh_dis)
)

# make dataframe of cell counts by quartile of p and owner
q <- data.frame(
  Owner = rep(c("Federal", "State", "County", "Municipal", "Non-profit", "Unprotected"),4),
  quartile = c(rep("Q1", 6), rep("Q2", 6),rep("Q3", 6),rep("Q4", 6)),
  count = c(q1,q2,q3,q4),
  order = c(rep(1,6), rep(2,6), rep(3,6), rep(4,6))
) %>%
  mutate(quartile = forcats::fct_reorder(quartile, order))

# saveRDS(q, "output/q.rds")
q <- readRDS("output/q.rds")

library(wesanderson)
library(ggpattern)
  ggplot() +
      geom_bar_pattern(aes(x = quartile, y = count*.09, 
                           fill = Owner, pattern = Owner), 
               data = q, 
               position = "fill",
               stat = "identity",
               pattern_color = "gray",
               pattern_fill = "transparent",
               color = "black") +
  geom_text(data=data.frame(x = c(1,4), y = c(-.02,-.02), 
                            q = c("Low quality", "High quality")),
            aes(x = x, y = y, label = q), size = 3, color = "darkgray") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "All marshland divided into quartiles\nby Black Rail habitat suitability",
       y = "% of area") +
  # scale_fill_manual(values= c(wes_palettes$Darjeeling1, wes_palettes$GrandBudapest1)) +
    scale_fill_manual(values = c("darkgray", "black", "white",
                                 "gray", "white", "black")) +
  theme_bw() +
  theme(text = element_text(size = 14))
  
# ggsave("figures/Fig2_ownership_of_rail_habitat_bw3.pdf", height = 5, width = 6.25, dpi = 600)
  
# assessing changes in percentages
qp1 <- q1/192056.9
qp4 <- q4/205930.4
```
# Characterizing private ownership (all marshes)
```{r}
npp_owners_marsh_trim <- npp_owners_marsh %>%
  filter(par_ha >= 0.1, marsh_ha >= 0.1)

discarded <- npp_owners_marsh %>%
  filter(par_ha <= 0.1, marsh_ha <= 0.1)

npp_owners_marsh_known <- npp_owners_marsh_trim %>%
  filter(owner_known == "Y")

# number of parcels (known and unknown ownership)
nrow(npp_owners_marsh_trim) # 4871 (was 4936 on 3/22/21 before final shps)
length(unique(npp_owners_marsh_trim$PAMS_PIN)) # 4871

# number of parcels (known ownership only)
nrow(npp_owners_marsh_known) # 3566 (was 3631 on 3/22/21)

# number of unique owner names
length(sort(unique(npp_owners_marsh_known$OWNER_NAME))) # 2655 (was 2684)
all_owners_df <- data.frame(owner = sort(unique(npp_owners_marsh_known$OWNER_NAME)))
```
# Manually screen private ownership names
```{r}
check = filter(npp_owners_marsh_known, substr(OWNER_NAME,1,1)=="Z") %>%
   arrange(OWNER_NAME) %>% dplyr::select(PAMS_PIN, OWNER_NAME, COUNTY, CALC_ACRE)
# manually checked all (through "Z")
```
# Manually tally private ownership states
```{r}
# AL, AZ, AR, CA, CO, CT, DE, FL, GA, IL, IN, KS, 
# ME, MD, MA, MI, MN, MO, NV, NH, NJ, NY, NC, OH, OK, PA
# RI, SC, TN, TX, UT, VT, VA, WV, WI
# not AK, HI, ID, IA, KY, LA, MS, MT, NE, NM, ND, OR, SD, WA, WY
check_state = filter(npp_owners_marsh_known, grepl(CITY_STATE, pattern = ", NJ")) %>%
  arrange(CITY_STATE) %>% 
  dplyr::select(PAMS_PIN, OWNER_NAME, CITY_STATE)
# manually checked for the presence of all states
```
# Owner zip code locations
```{r}
# Load zip code look-up date retrieved from: 
#public.opendatasoft.com/explore/dataset/us-zip-code-latitude-and-longitude/table/
# imported to Excel, then saved as csv.
zip <- read.csv("data/zip_codes.csv", colClasses = "character")
head(zip)

# make sf data based of known owner locations and parcel centroids
locations_sf = npp_owners_marsh_known %>%
  filter(CITY_STATE != "UNKNOWN",
         CITY_STATE != "N.J.TURNPIKE") %>% # removes 31 parcels
  mutate(Zip = ZIP5) %>%
  left_join(zip, by = "Zip") %>%
  dplyr::select(PAMS_PIN, OWNER_NAME, ST_ADDRESS, CITY_STATE, 
                Zip, Latitude, Longitude) %>%
  mutate(Latitude = case_when(CITY_STATE == "FULLERTON, CA" ~ 33.8704,
                              Zip == 18975 ~ 40.2068, # Zip typo: WARMINSTER, PA
                            CITY_STATE == "PHILADELPHIA, PA" & is.na(Zip) ~ 39.9526,
                              Zip == "08439" ~ 39.25682, # Zip typo: Port Norris, NJ
                              Zip == 10300 ~ 40.54717, # Yacht Club Dr, Staten Isl
                              CITY_STATE == "WASHINGTON D C" ~ 38.9072,
                              CITY_STATE == "ATHENS  GREECE" ~ 37.9838,
                              TRUE ~ as.numeric(Latitude)),
         Longitude = case_when(CITY_STATE == "FULLERTON, CA" ~ -117.9242,
                              Zip == 18975 ~ -75.0998, # Zip typo: WARMINSTER, PA
                          CITY_STATE == "PHILADELPHIA, PA" & is.na(Zip) ~ -75.1652,
                          Zip == "08439" ~ -75.06683, # Zip typo: Port Norris, NJ
                              Zip == 10300 ~ -74.13839, # Yacht Club Dr, Staten Isl
                              CITY_STATE == "WASHINGTON D C" ~ -77.0369,
                              CITY_STATE == "ATHENS  GREECE" ~ 23.7275,
                              TRUE ~ as.numeric(Longitude))) %>%
  mutate(centroids = st_centroid(geometry),
         lineid = 1:length(PAMS_PIN))

# Make sf of the owner zip code locations
owner_locations <- locations_sf %>%
  as.data.frame() %>%
  st_as_sf(coords = c("Longitude", "Latitude"),
           crs = 4326)

# Make sf of the parcel centroid locations
parcel_centroids <- locations_sf %>%
  as.data.frame() %>%
  st_as_sf(geometry = locations_sf$centroids,
           crs = map_proj) %>% 
  st_transform(crs = 4326)

# plot them to test
plot(st_geometry(owner_locations))
plot(st_geometry(parcel_centroids))

# get lat long coordinates of owners and parcels & distance calculations
p1 = st_coordinates(owner_locations)
p2 = st_coordinates(parcel_centroids)
distances = geosphere::distHaversine(p1, p2)/1000 # distances in km

# make historgram of distances
hist(log10(distances))

# join distances to owner_locations
dist_frame <- owner_locations %>%
  as.data.frame() %>%
  mutate(dist = distances) %>%
  dplyr::select(PAMS_PIN, dist)

owner_lines = parcel_centroids %>%
  dplyr::select(-Latitude, -Longitude, -centroids) %>%
  bind_rows(dplyr::select(owner_locations, -centroids)) %>%
  group_by(PAMS_PIN, OWNER_NAME, ST_ADDRESS, CITY_STATE, Zip, lineid) %>%
  summarise() %>%
  st_cast("LINESTRING") %>%
  st_transform(crs = mol)

library(rnaturalearth)
ne_land <- ne_countries(scale = 50, returnclass = "sf") %>%
   filter(continent %in% c("North America", "Europe")) %>%
  st_set_precision(1e6) %>%
   st_union() %>% 
   st_geometry() %>%
  st_as_sf()

ggplot(ne_land) +
  geom_sf() +
  geom_sf(data = owner_lines, color = alpha("firebrick", 0.2),
          size = 0.5) +
  lims(x = c(-150,23), y = c(15,62.75)) +
  theme_bw()

ggsave("figures/Fig4_owner_locations.pdf", 
       width = 7, height = 4, dpi = 600)
```
# Parcel info scatterplot matrix
```{r}
parcel_info <- npp_owners_marsh_known %>%
  st_drop_geometry() %>% as.data.frame() %>%
  left_join(dist_frame, by = "PAMS_PIN") %>%
  filter(is.na(dist)==F,
         NET_VALUE > 0) %>%
  mutate(
    l.dist = log10(dist),
    l.par_ha = log10(par_ha),
    p.marsh = 100 * marsh_ha / par_ha,
    netval_ha = NET_VALUE / par_ha,
    l.net_val = log10(NET_VALUE),
    l.netval_ha = log10(netval_ha)
  ) %>%
  dplyr::select(PAMS_PIN, l.par_ha, p.marsh, l.net_val, l.netval_ha,
                dist, par_ha, net_val = NET_VALUE, netval_ha)
  
# ggpairs plot. Found code here:
# https://www.r-bloggers.com/2016/02/multiple-regression-lines-in-ggpairs/
my_smooth_fn <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point(color = "steelblue", alpha = 0.5, shape = 1, size = 1) + 
    geom_density_2d(color = "black", size = 0.5, alpha = 0.5) +
    geom_smooth(method=loess, fill="steelblue", color="black", size = 0.5, ...)
  p
}

my_bar_fn <- function(data, mapping, ...){
  the_mean <- mean(data)
  p <- ggplot(data = data, mapping = mapping) + 
    geom_histogram(color = "darkblue", 
                   fill = "steelblue", alpha = 0.5, bins = 15) +
    geom_vline(xintercept = mean(data$x), color = "red")
}

library(GGally)
#require(scales)
options(scipen=10000, digits = 0)
g = ggpairs(parcel_info, columns = 2:5, 
            lower = list(continuous = my_smooth_fn),
            diag = list(continuous = my_bar_fn),
            upper = list(continuous = wrap("cor", method = "spearman")),
            columnLabels = c("Parcel area\n(log10 ha)", 
                             "Marsh fraction\n(%)", 
                             "Net value\n(log10 USD)",
                             "Relative net value\n(log10 USD / ha)")) +
  theme_bw()
g

 # ggsave("histograms_spearman_regular_axis3.jpg", dpi = 400, width = 7, height = 7)

 # ggsave("histograms_spearman_log_axes.jpg", dpi = 400, width = 7, height = 7)
 options(digits = 7)
 
  # ggsave("histograms_spearman_log_axes_relUSD.svg", dpi = 400, width = 7, height = 7)
 options(digits = 7)
 
 ggplot(parcel_info) +
   geom_histogram(aes(x = log10(net_val)), bins = 15, color = "gray") +
   geom_vline(xintercept = median(log10(parcel_info$net_val)), color = "red")
 
  ggplot(parcel_info) +
   geom_histogram(aes(x = log10(netval_ha)), bins = 15, color = "gray") +
   geom_vline(xintercept = median(log10(parcel_info$netval_ha)), color = "red")
 
  ggplot(parcel_info) +
   geom_histogram(aes(x = p.marsh), bins = 15, color = "gray") +
   geom_vline(xintercept = median(parcel_info$p.marsh), color = "red")
  
   ggplot(parcel_info) +
   geom_histogram(aes(x = log10(par_ha)), bins = 15, color = "gray") +
   geom_vline(xintercept = median(log10(parcel_info$par_ha)), color = "red")
   
   ggplot(parcel_info) +
   geom_histogram(aes(x = log10(dist)), bins = 15, color = "gray") +
   geom_vline(xintercept = median(log10(parcel_info$dist)), color = "red")
```
# summary stats of parcel and owner characteristics
```{r}
# median net value of parcels (marsh & non-marsh)
npp_value <- npp_owners_marsh_known %>% filter(NET_VALUE > 0)
mean(npp_value$NET_VALUE) # $630277
median(npp_value$NET_VALUE) # $36,100
summary(npp_value$NET_VALUE) 
sum(npp_value$NET_VALUE) # 2224877017
net_val = data.frame(pin = npp_owners_marsh_known$PAMS_PIN,
                     var = "Net value", 
                     value = npp_owners_marsh_known$NET_VALUE)

# median net value per hectare
npp_value$netval_ha <- npp_value$NET_VALUE / npp_value$par_ha
summary(npp_value$netval_ha) 
    # Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
    #   12     1762     9830   248076   134264 15623758 

# Size of parcels (marsh and non-marsh)
summary(npp_owners_marsh_known$par_ha)
   #   Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
   # 0.1022    0.8111    2.4591    9.1867    7.4333 1479.5429
hist(log10(par_size$par_ha))


# median size of marsh portion of parcels
median(npp_owners_marsh_known$marsh_ha); hist(log10(npp_owners_marsh_known$marsh_ha)) # 
# marsh fraction 
marsh_fraction <- npp_owners_marsh_known$marsh_ha  / npp_owners_marsh_known$par_ha
summary(npp_owners_marsh_known$marsh_ha)


# median proportion of parcel that is marsh
proportion.area <- filter(npp_owners_marsh_known, CALC_ACRE != 0 & CALC_ACRE* 0.404686 > ha)
median(100 * proportion.area$ha / (proportion.area$CALC_ACRE * 0.404686)) # 55%
hist(proportion.area$ha / (proportion.area$CALC_ACRE * 0.404686)) # 60%
```
# Owner stats for top quartile of rail habitat
```{r}

# load top quartile of black rail habitat
ensp.ebird_q4 <- readRDS("D:/black_rail/big_output_2021_11/rds/ensp.ebird_q4.rds")
q4_mask <- ensp.ebird_q4
q4_mask[is.na(q4_mask) != T] <- 1
plot(q4_mask)
q4_mask_stars <- stars::st_as_stars(q4_mask)

# converge top quartile habitat into vector polygon 
# https://r-spatial.github.io/stars/articles/stars5.html
p = st_as_sf(q4_mask_stars, as_points = FALSE, merge = TRUE)
p_dis <- p %>% st_make_valid() %>% group_by() %>% summarise()

# extract just the parcels that overlap with the best habitat
# takes a long time
# npp_owners_marsh_q4 = npp_owners_marsh_trim %>%
#   st_filter(., p_dis, .pred = st_intersects)
# saveRDS(npp_owners_marsh_q4, "output/npp_owners_marsh_q4.rds")
npp_owners_marsh_q4 <- readRDS("output/npp_owners_marsh_q4.rds")

# how many total parcels with top quartile habitat?
nrow(npp_owners_marsh_q4) # 487

# extract the parcels with known owners
npp_owners_marsh_q4_known <- npp_owners_marsh_q4 %>%
  filter(owner_known == "Y"); 

# how many parcels with known owners?
nrow(npp_owners_marsh_q4_known) # 384

# how many unique owners?
q4_owners <- unique(npp_owners_marsh_q4_known$OWNER_NAME); length(q4_owners) # 266

# median net value of parcels (marsh & non-marsh)
npp_q4_value <- npp_owners_marsh_q4_known %>% filter(NET_VALUE > 0)
mean(npp_q4_value$NET_VALUE) # $125969
median(npp_q4_value$NET_VALUE) # $11,200
summary(npp_q4_value$NET_VALUE) # max = 4612500
sum(npp_q4_value$NET_VALUE) # 48246100
48246100/2224877017

npp_q4_value2 <- npp_owners_marsh_q4 %>% filter(NET_VALUE > 0)
sum(npp_q4_value2$NET_VALUE) # 48246100

# summary of net value / ha
npp_q4_value$netval_ha <- npp_q4_value$NET_VALUE / npp_q4_value$par_ha
summary(npp_q4_value$netval_ha)
     # Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
     # 80.5    1083.1    1973.9   50599.5    6120.7 2489002.4 
     
# Size of parcels (marsh and non-marsh)
summary(npp_owners_marsh_q4_known$par_ha)
  #  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  # 0.109   2.037   4.835  17.216  14.096 977.017 

hist(log10(npp_owners_marsh_q4_known$par_ha))


# median size of marsh portion of parcels
median(npp_owners_marsh_q4_known$marsh_ha);  hist(log10(npp_owners_marsh_q4_known$marsh_ha)) # 4.0 ha

# marsh fraction 
marsh_fraction <- npp_owners_marsh_q4_known$marsh_ha  / npp_owners_marsh_q4_known$par_ha
summary(marsh_fraction)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# 0.005113 0.668419 0.867125 0.776647 0.936720 1.000001 


parcel_info_q4 <- parcel_info %>%
  filter(PAMS_PIN %in% unique(npp_owners_marsh_q4_known$PAMS_PIN))

summary(parcel_info_q4$dist)
   #  Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
   # 0.854    6.200   11.212  187.264   94.080 3935.605 


```
# Re-running JAGS model with year as continuous variable
```{r}
# Inits
inits <- function(){list(z = apply(b.occ.mat.ensp_ebird, 1, max, na.rm = T), mean.psi = runif(1), mean.p = runif(1), alpha = c(-1, 1) + rnorm(2), beta = (c(-2, -1,2, 0,-2,-2)+rnorm(6)))}

# Parameters monitored
params <- c("alpha0", "alpha", "beta0", "beta", "psi.yr")

# MCMC settings
# ni <- 230000   ;   nt <- 10   ;   nb <- 30000   ;   nc <- 3 # for LOO calculations & params
ni <- 50000   ;   nt <- 10   ;   nb <- 10000   ;   nc <- 3 # for prediction

# Call JAGS from R and summarize posteriors
ensp_ebird_p.ord.dur_psi.yrcont.ss.hm.tb.ld.im <-
  jagsUI::jags(
    ensp_ebird.jags.data_yr,
    inits,
    params,
"scripts/ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_predictions_yr.txt",
    n.chains = nc,
    n.thin = nt,
    n.iter = ni,
    n.burnin = nb,
    parallel = TRUE
  )
# jagsUI::traceplot(ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im)
# ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im

 saveRDS(ensp_ebird_p.ord.dur_psi.yrcont.ss.hm.tb.ld.im, file = "D:/black_rail/big_output_2022_07/JAGS_ensp_ebird_p.ord.dur_psi.yrcont.ss.hm.tb.ld.im_12000iter.rds")
```
# Creating prediction surface based on 'continuous year' model
Note: this was run on the Amarel HPC cluster. See R script, BASH script, and BUGS model with the name 'ensp_ebird_cell_predict_yrcon_for_Amarel' in the "scripts/amarel/" folder. The output was saved to "D:/black_rail/big_output_2022_07/ensp_ebird_cell_predict_out_yrcon.csv".

# Create tables of model outputs comparing year as factor vs. continuous
```{r}
load("D:/black_rail/big_output_2021_10/rda/JAGS_ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im_12000iter_pred_full.Rdata")
ee <- ensp_ebird_p.ord.dur_psi.yr.ss.hm.tb.ld.im

 ee_ycon <-
  readRDS("D:/black_rail/big_output_2022_07/JAGS_ensp_ebird_p.ord.dur_psi.yrcont.ss.hm.tb.ld.im_12000iter.rds")

ee.t <- ee$summary[c(1:20,334),c(5,3,7:9)] %>%
  as.data.frame() %>%
  mutate(vname = c("Intercept", "Date", "Duration", "Intercept", colnames(ensp_ebird.jags.data$occDM_hm), "Deviance")) %>%
  dplyr::select(6,1:5)

ee_ycon.t <- ee_ycon$summary[1:11, c(5,3,7:9)] %>%
  as.data.frame() %>%
  mutate(vname = c("Intercept", "Date", "Duration", "Intercept", colnames(ensp_ebird.jags.data_yr$occDM_hm), "Deviance")) %>%
  dplyr::select(6,1:5)

library(kableExtra)

# make output table for 'continous year' model
options(digits = 4)
ee_ycon_table <- ee_ycon.t %>%
  kbl(caption = "Black rail JAGS occupancy model output - year as a categorical variable") %>%
  kable_classic(full_width = F, html_font = "Cambria")

ee_ycon_table

# save the table to HTML file
save_kable(ee_ycon_table,
           "output/ensp_ebird.ycon.jags.out.table.html")

# make output table for 'categorical year' model
ee_table <- ee.t %>%
  kbl(caption = "Black rail JAGS occupancy model output - year as a categorical variable") %>%
  kable_classic(full_width = F, html_font = "Cambria")

ee_table

# save the table to HTML file
save_kable(ee_table,
           "output/ensp_ebird.jags.out.table.html")

```